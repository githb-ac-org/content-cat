#!/usr/bin/env bash
#
# Content Cat - One command to run everything
#

set -e

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
DIM='\033[2m'
NC='\033[0m'

# Find project directory
find_project() {
    # Check if running from within the project
    if [[ -f "./package.json" ]] && grep -q '"name": "content-cat"' ./package.json 2>/dev/null; then
        echo "$(pwd)"
        return
    fi

    # Check common locations
    local locations=(
        "$HOME/content-cat"
        "$HOME/Content-Cat"
        "$HOME/projects/content-cat"
        "$HOME/dev/content-cat"
        "$HOME/Documents/content-cat"
        "/opt/content-cat"
    )

    for loc in "${locations[@]}"; do
        if [[ -f "$loc/package.json" ]] && grep -q '"name": "content-cat"' "$loc/package.json" 2>/dev/null; then
            echo "$loc"
            return
        fi
    done

    # Not found
    echo ""
}

INSTALL_DIR=$(find_project)

# Not installed - run installer
if [[ -z "$INSTALL_DIR" ]]; then
    echo -e "${YELLOW}Content Cat not found. Installing to ~/content-cat...${NC}"
    echo ""

    # Download and run installer
    INSTALLER_URL="https://raw.githubusercontent.com/KenKaiii/content-cat/main/scripts/install.sh"

    if command -v curl &>/dev/null; then
        bash <(curl -fsSL "$INSTALLER_URL")
    elif command -v wget &>/dev/null; then
        bash <(wget -qO- "$INSTALLER_URL")
    else
        echo -e "${RED}Error: curl or wget required${NC}"
        exit 1
    fi
    exit 0
fi

cd "$INSTALL_DIR"

echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}  Content Cat${NC} ðŸ±"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Detect OS
OS="linux"
if [[ "$OSTYPE" == "darwin"* ]]; then
    OS="macos"
elif [[ -f /proc/version ]] && grep -qi microsoft /proc/version; then
    OS="wsl"
fi

# Start Docker services if available
if command -v docker &>/dev/null; then
    # Check if Docker daemon is running
    if ! docker info &>/dev/null 2>&1; then
        echo -e "${YELLOW}Starting Docker...${NC}"

        case $OS in
            macos)
                open -a Docker 2>/dev/null || true
                echo -e "${DIM}Waiting for Docker Desktop...${NC}"
                local count=0
                while ! docker info &>/dev/null 2>&1; do
                    sleep 2
                    ((count++))
                    if [[ $count -gt 30 ]]; then
                        echo -e "${YELLOW}âš  Docker taking too long, continuing without it${NC}"
                        break
                    fi
                done
                ;;
            wsl)
                # WSL: Docker Desktop should be running in Windows
                echo -e "${YELLOW}âš  Start Docker Desktop in Windows${NC}"
                echo -e "${DIM}Waiting for Docker...${NC}"
                local count=0
                while ! docker info &>/dev/null 2>&1; do
                    sleep 2
                    ((count++))
                    if [[ $count -gt 15 ]]; then
                        echo -e "${YELLOW}âš  Docker not available, using local database${NC}"
                        break
                    fi
                done
                ;;
            linux)
                # Try starting Docker service
                sudo systemctl start docker 2>/dev/null || true
                sleep 2
                ;;
        esac
    fi

    # Start database containers if Docker is available
    if docker info &>/dev/null 2>&1; then
        if ! docker ps --format '{{.Names}}' 2>/dev/null | grep -q "content-cat-db"; then
            echo -e "${GREEN}â–¶${NC} Starting PostgreSQL and Redis..."
            docker compose up -d postgres redis 2>/dev/null || docker-compose up -d postgres redis 2>/dev/null || true
            sleep 3
        else
            echo -e "${GREEN}âœ“${NC} Database services running"
        fi
    fi
else
    echo -e "${DIM}Docker not installed - ensure PostgreSQL is running locally${NC}"
fi

# Check if pnpm is available
if ! command -v pnpm &>/dev/null; then
    echo -e "${YELLOW}Installing pnpm...${NC}"
    npm install -g pnpm 2>/dev/null || corepack enable && corepack prepare pnpm@latest --activate
fi

# Start the app
echo -e "${GREEN}â–¶${NC} Starting Content Cat..."
echo ""
echo -e "  ${CYAN}http://localhost:3000${NC}"
echo -e "  ${DIM}Press Ctrl+C to stop${NC}"
echo ""

pnpm dev
